# 在 GitHub Actions 中编译本仓库的 GKI 内核（可选集成 KernelSU）
# 触发: 手动 workflow_dispatch，或 push 到 main/master 时自动构建
# 产物: Image, Image.gz, Image.lz4 上传为 Artifacts；可选创建 Release
#
# 支持两种仓库结构：内核在仓库根目录，或在内层子目录（如 android_16.0_kernel_MT6989）
name: Build GKI Kernel

on:
  workflow_dispatch:
    inputs:
      with_kernelsu:
        description: 'Integrate KernelSU (run setup.sh in kernel root)'
        required: false
        default: false
        type: boolean
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  OUT_DIR: ${{ github.workspace }}/out
  ARCH: arm64
  CLANG_VERSION: r487747c

jobs:
  build:
    name: Build kernel (arm64)
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    permissions:
      contents: write

    steps:
      - name: Checkout kernel source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 解决「远程有文件但 workflow 找不到」：仓库根可能是父目录，内核在子目录
      - name: Detect kernel root
        id: kernel_root
        run: |
          root="$GITHUB_WORKSPACE"
          if [ -f "$root/arch/arm64/configs/gki_defconfig" ]; then
            echo "kernel_root=$root" >> $GITHUB_OUTPUT
            echo "KERNEL_ROOT=$root" >> $GITHUB_ENV
            echo "Kernel root: repo root ($root)"
            exit 0
          fi
          for subdir in android_16.0_kernel_MT6989 kernel source .; do
            [ "$subdir" = "." ] && continue
            if [ -f "$root/$subdir/arch/arm64/configs/gki_defconfig" ]; then
              echo "kernel_root=$root/$subdir" >> $GITHUB_OUTPUT
              echo "KERNEL_ROOT=$root/$subdir" >> $GITHUB_ENV
              echo "Kernel root: $root/$subdir"
              exit 0
            fi
          done
          echo "::error::arch/arm64/configs/gki_defconfig not found under $root (and checked subdirs: android_16.0_kernel_MT6989, kernel, source)"
          ls -la "$root" 2>/dev/null || true
          exit 1

      - name: Verify build-required files
        run: |
          cd "$KERNEL_ROOT"
          echo "Commit: $(git rev-parse HEAD)"
          echo "Contents of arch/arm64/configs/:"
          ls -la arch/arm64/configs/ 2>/dev/null || true
          missing=
          [ -f arch/arm64/configs/gki_defconfig ] || missing="arch/arm64/configs/gki_defconfig"
          [ -f arch/arm64/configs/vivo_restore_gki.fragment ] || missing="$missing arch/arm64/configs/vivo_restore_gki.fragment"
          if [ -n "$missing" ]; then
            echo "::error::Missing in repo:$missing"
            echo "Ensure these files are on this branch (merge main or push arch/arm64/configs/). Then re-run workflow."
            exit 1
          fi

      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 4096
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'

      - name: Install dependencies and LLVM 18 (apt.llvm.org)
        timeout-minutes: 15
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq --no-install-recommends \
            build-essential libncurses-dev flex bison libssl-dev bc \
            python3 libelf-dev gcc-aarch64-linux-gnu wget ca-certificates gnupg
          wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | sudo gpg --dearmor -o /usr/share/keyrings/llvm-snapshot.gpg
          echo "deb [signed-by=/usr/share/keyrings/llvm-snapshot.gpg] http://apt.llvm.org/$(lsb_release -cs)/ llvm-toolchain-$(lsb_release -cs)-18 main" | sudo tee /etc/apt/sources.list.d/llvm.list
          sudo apt-get update -qq
          sudo apt-get install -y -qq --no-install-recommends clang-18 lld-18 llvm-18
          echo "LLVM18_BIN=/usr/lib/llvm-18/bin" >> $GITHUB_ENV

      - name: Setup KernelSU (optional)
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.with_kernelsu == 'true' }}
        timeout-minutes: 5
        run: |
          cd "$KERNEL_ROOT"
          if [ ! -d "drivers" ]; then
            echo "::warning::\"drivers/\" not found in kernel root, skipping KernelSU."
            exit 0
          fi
          if [ -d "./KernelSU" ]; then rm -rf ./KernelSU; fi
          if [ -d "./drivers/kernelsu" ]; then rm -rf ./drivers/kernelsu; fi
          curl -LSs --connect-timeout 15 --max-time 120 "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s main

      - name: Merge defconfig and build kernel
        run: |
          set -e
          cd "$KERNEL_ROOT"
          export PATH="$LLVM18_BIN:$PATH"
          export CC=clang-18
          export CLANG_TRIPLE=aarch64-linux-gnu-
          export CROSS_COMPILE=aarch64-linux-gnu-
          echo "Using Clang 18 from apt.llvm.org: $(which clang-18) $(clang-18 --version | head -1)"
          mkdir -p "$OUT_DIR"
          if [ -f scripts/kconfig/merge_config.sh ]; then
            KCONFIG_CONFIG="$OUT_DIR/.config" scripts/kconfig/merge_config.sh -m -r \
              arch/arm64/configs/gki_defconfig \
              arch/arm64/configs/vivo_restore_gki.fragment
          else
            echo "::warning::scripts/kconfig/merge_config.sh not found, merging with cat + olddefconfig"
            cat arch/arm64/configs/gki_defconfig arch/arm64/configs/vivo_restore_gki.fragment > "$OUT_DIR/.config"
          fi
          make O="$OUT_DIR" ARCH=arm64 olddefconfig
          make O="$OUT_DIR" ARCH=arm64 \
            CROSS_COMPILE="$CROSS_COMPILE" \
            LLVM=1 LLVM_IAS=1 \
            Image Image.gz Image.lz4 modules \
            -j"$(nproc)"

      - name: Upload kernel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ github.run_number }}-${{ github.sha }}
          path: |
            ${{ env.OUT_DIR }}/arch/arm64/boot/Image
            ${{ env.OUT_DIR }}/arch/arm64/boot/Image.gz
            ${{ env.OUT_DIR }}/arch/arm64/boot/Image.lz4
          retention-days: 7

      - name: Create Release (manual run only)
        if: github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        continue-on-error: true
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ github.run_number }}
          name: "GKI build ${{ github.run_number }}"
          files: |
            ${{ env.OUT_DIR }}/arch/arm64/boot/Image
            ${{ env.OUT_DIR }}/arch/arm64/boot/Image.gz
            ${{ env.OUT_DIR }}/arch/arm64/boot/Image.lz4
          generate_release_notes: true
          draft: false
