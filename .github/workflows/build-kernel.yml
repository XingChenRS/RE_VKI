# 在 GitHub Actions 中编译本仓库的 GKI 内核（可选集成 KernelSU）
# 触发: 手动 workflow_dispatch，或 push 到 main/master 时自动构建
# 产物: Image, Image.gz, Image.lz4 上传为 Artifacts；可选创建 Release
#
# 参考:
#   - Google android14-6.1 发布 build: https://source.android.com/docs/core/architecture/kernel/gki-android14-6_1-release-builds
#   - mcxiaochenn/Action_OKI_KernelSU_SUSFS: 使用 apt.llvm.org 安装固定版本 Clang（非 AOSP prebuilts），
#     repo init 拉取厂商 manifest 后 Bazel 构建；本 workflow 采用其「apt 安装 LLVM」方式，用 LLVM 18 编译 AOSP GKI 源码树。
# 上游链接:
#   - KernelSU: https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh
#   - LLVM 18: apt.llvm.org llvm-toolchain-jammy-18（与 mcxiaochenn 用 clang-19 思路一致，固定工具链版本）
name: Build GKI Kernel

on:
  workflow_dispatch:
    inputs:
      with_kernelsu:
        description: 'Integrate KernelSU (run setup.sh in kernel root)'
        required: false
        default: true
        type: boolean
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  OUT_DIR: ${{ github.workspace }}/out
  ARCH: arm64
  CLANG_VERSION: r487747c

jobs:
  build:
    name: Build kernel (arm64)
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    permissions:
      contents: write  # 用于 Create Release 步骤

    steps:
      - name: Checkout kernel source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 4096
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'

      - name: Install dependencies and LLVM 18 (apt.llvm.org)
        timeout-minutes: 15
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq --no-install-recommends \
            build-essential libncurses-dev flex bison libssl-dev bc \
            python3 libelf-dev gcc-aarch64-linux-gnu wget ca-certificates gnupg
          # 参考 mcxiaochenn/Action_OKI_KernelSU_SUSFS：用 apt.llvm.org 固定 Clang 版本，避免 AOSP prebuilts 无法下载
          wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | sudo gpg --dearmor -o /usr/share/keyrings/llvm-snapshot.gpg
          echo "deb [signed-by=/usr/share/keyrings/llvm-snapshot.gpg] http://apt.llvm.org/$(lsb_release -cs)/ llvm-toolchain-$(lsb_release -cs)-18 main" | sudo tee /etc/apt/sources.list.d/llvm.list
          sudo apt-get update -qq
          sudo apt-get install -y -qq --no-install-recommends clang-18 lld-18 llvm-18
          # 供后续步骤使用
          echo "LLVM18_BIN=/usr/lib/llvm-18/bin" >> $GITHUB_ENV

      - name: Setup KernelSU (optional)
        if: ${{ github.event.inputs.with_kernelsu != 'false' && github.event_name != 'pull_request' }}
        timeout-minutes: 5
        run: |
          if [ -d "./KernelSU" ]; then rm -rf ./KernelSU; fi
          if [ -d "./drivers/kernelsu" ]; then rm -rf ./drivers/kernelsu; fi
          curl -LSs --connect-timeout 15 --max-time 120 "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s main

      - name: Merge defconfig and build kernel
        run: |
          set -e
          # 使用 apt.llvm.org 安装的 LLVM 18（与 mcxiaochenn 用 clang-19 思路一致）
          export PATH="$LLVM18_BIN:$PATH"
          export CC=clang-18
          export CLANG_TRIPLE=aarch64-linux-gnu-
          export CROSS_COMPILE=aarch64-linux-gnu-
          echo "Using Clang 18 from apt.llvm.org: $(which clang-18) $(clang-18 --version | head -1)"
          mkdir -p "$OUT_DIR"
          # 合并 gki_defconfig + vivo_restore_gki.fragment
          KCONFIG_CONFIG="$OUT_DIR/.config" scripts/kconfig/merge_config.sh -m -r \
            arch/arm64/configs/gki_defconfig \
            arch/arm64/configs/vivo_restore_gki.fragment
          make O="$OUT_DIR" ARCH=arm64 olddefconfig
          # 构建 Image, Image.gz, Image.lz4, modules
          make O="$OUT_DIR" ARCH=arm64 \
            CROSS_COMPILE="$CROSS_COMPILE" \
            LLVM=1 LLVM_IAS=1 \
            Image Image.gz Image.lz4 modules \
            -j"$(nproc)"

      - name: Upload kernel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ github.run_number }}-${{ github.sha }}
          path: |
            ${{ env.OUT_DIR }}/arch/arm64/boot/Image
            ${{ env.OUT_DIR }}/arch/arm64/boot/Image.gz
            ${{ env.OUT_DIR }}/arch/arm64/boot/Image.lz4
          retention-days: 7

      - name: Create Release (manual run only)
        if: github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        continue-on-error: true
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ github.run_number }}
          name: "GKI build ${{ github.run_number }}"
          files: |
            ${{ env.OUT_DIR }}/arch/arm64/boot/Image
            ${{ env.OUT_DIR }}/arch/arm64/boot/Image.gz
            ${{ env.OUT_DIR }}/arch/arm64/boot/Image.lz4
          generate_release_notes: true
          draft: false
